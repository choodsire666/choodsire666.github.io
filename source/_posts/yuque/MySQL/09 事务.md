---
title: 09 事务
urlname: dngtpspqb15m7mzi
date: '2024-03-13 17:32:33'
updated: '2024-04-11 15:26:10'
cover: 'https://cdn.nlark.com/yuque/0/2024/png/29688613/1712820366707-b2128102-0cc0-4494-b5c6-fbc9ac724b77.png'
description: '笔记来源：黑马程序员 MySQL数据库入门到精通，从mysql安装到mysql高级、mysql优化全囊括1 事务简介事务是一组操作的集合，它是一个不可分割的工作单位，事务会把所有的操作作为一个整体一起向系统提交或撤销操作请求，即这些操作要么同时成功，要么同时失败。就比如: 张三给李四转账100...'
---
**笔记来源：**[黑马程序员 MySQL数据库入门到精通，从mysql安装到mysql高级、mysql优化全囊括](https://www.bilibili.com/video/BV1Kr4y1i7ru/?spm_id_from=333.337.search-card.all.click&vd_source=e8046ccbdc793e09a75eb61fe8e84a30)

## **1 事务简介**

**事务**是一组操作的集合，它是一个不可分割的工作单位，事务会把所有的操作作为一个整体一起向系统提交或撤销操作请求，即这些操作要么同时成功，要么同时失败。
就比如: 张三给李四转账1000块钱，张三银行账户的钱减少1000，而李四银行账户的钱要增加1000。 这一组操作就必须在一个事务的范围内，要么都成功，要么都失败。 
![](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fimg2022.cnblogs.com%2Fblog%2F2217415%2F202205%2F2217415-20220505215729675-686542799.png&sign=e6b69f1fd900d6e188811d0b2e902606d904992e85b1081206ac6ebee5481c90#from=url&id=lDPKp&originHeight=219&originWidth=1253&originalType=binary&ratio=1.2395833730697632&rotation=0&showTitle=false&status=done&style=none&title=)
正常情况：转账这个操作, 需要分为以下这么三步来完成 , 三步完成之后, 张三减少1000, 而李四增加1000, 转账成功 : 
![](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fimg2022.cnblogs.com%2Fblog%2F2217415%2F202205%2F2217415-20220505215747367-1044727964.png&sign=ce618d67904169c25b8d303d714516c7a7e847be131e724402f650773fa5b381#from=url&id=yG0oM&originHeight=318&originWidth=1305&originalType=binary&ratio=1.2395833730697632&rotation=0&showTitle=false&status=done&style=none&title=)
异常情况：转账这个操作, 也是分为以下这么三步来完成 , 在执行第三步是报错了, 这样就导致张三减少1000块钱, 而李四的金额没变, 这样就造成了数据的不一致, 就出现问题了。 
![](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fimg2022.cnblogs.com%2Fblog%2F2217415%2F202205%2F2217415-20220505215807932-2003006191.png&sign=5e8a22146c64907e4a23ab773d5f92a6c06f5d901ec746d3c3633eea8e84b0a1#from=url&id=Wzji7&originHeight=483&originWidth=1270&originalType=binary&ratio=1.2395833730697632&rotation=0&showTitle=false&status=done&style=none&title=)
为了解决上述的问题，就需要通过数据的事务来完成，我们只需要在业务逻辑执行之前开启事务，执行完毕后提交事务。如果执行过程中报错，则回滚事务，把数据恢复到事务开始之前的状态。 
![](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fimg2022.cnblogs.com%2Fblog%2F2217415%2F202205%2F2217415-20220505215829428-1464323206.png&sign=a469d16f459eca52982e2027f17cd66c3f3c91801ffc8fbb2efc444895bcc02d#from=url&id=uTQGc&originHeight=450&originWidth=1240&originalType=binary&ratio=1.2395833730697632&rotation=0&showTitle=false&status=done&style=none&title=)
注意： 默认MySQL的事务是自动提交的，也就是说，当执行完一条DML语句时，MySQL会立即隐式的提交事务。

## **2 事务操作**

数据准备：

### **2.1 未控制事务**

1. 测试正常情况
测试完毕之后检查数据的状态, 可以看到数据操作前后是一致的。 
![](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fimg2022.cnblogs.com%2Fblog%2F2217415%2F202205%2F2217415-20220505220115555-580664995.png&sign=57ce7aeb6a0cf039bfc098d0de7582fe419e653f88b47961159504a2527f0b87#from=url&id=iszY2&originHeight=231&originWidth=869&originalType=binary&ratio=1.2395833730697632&rotation=0&showTitle=false&status=done&style=none&title=)

2. 测试异常情况
我们把数据都恢复到2000， 然后再次一次性执行上述的SQL语句(出错了.... 这句话不符合SQL语 法,执行就会报错)，检查最终的数据情况, 发现数据在操作前后不一致了。 
![](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fimg2022.cnblogs.com%2Fblog%2F2217415%2F202205%2F2217415-20220505220233300-1614034931.png&sign=3c38a83468df8f2c801b35b86f75538a5ee11e254030218a6fc2afd9928771cd#from=url&id=CKnqE&originHeight=209&originWidth=855&originalType=binary&ratio=1.2395833730697632&rotation=0&showTitle=false&status=done&style=none&title=)

### **2.2 控制事务一**

1查看/设置事务提交方式
2提交事务
3回滚事务
注意：上述的这种方式，我们是修改了事务的自动提交行为, 把默认的自动提交修改为了手动提交, 此时我们执行的DML语句都不会提交, 需要手动的执行commit进行提交。

### **2.3 控制事务二**

1开启事务
2提交事务
3回滚事务

转账案例：

## **3 事务四大特性**
![image.png](https://raw.githubusercontent.com/choodsire666/blog-img/main/09 事务/35295da3daf8654d9985ba169a01104e.png)
●原子性（Atomicity）：事务是不可分割的最小操作单元，要么全部成功，要么全部失败。
●一致性（Consistency）：事务完成时，必须使所有的数据都保持一致状态。
●隔离性（Isolation）：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行。
●持久性（Durability）：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的。
上述就是事务的四大特性，简称ACID。 
![](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fimg2022.cnblogs.com%2Fblog%2F2217415%2F202205%2F2217415-20220505220737640-1206556436.png&sign=2b0640d00fb41918fe78ea8dd8859b0f03d060f2cefd24a0932ecbbed30fb810#from=url&id=EvbWF&originHeight=818&originWidth=1168&originalType=binary&ratio=1.2395833730697632&rotation=0&showTitle=false&status=done&style=none&title=)

## **4 并发事务问题**

1赃读：一个事务读到另外一个事务还没有提交的数据。
![](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fimg2022.cnblogs.com%2Fblog%2F2217415%2F202205%2F2217415-20220505220803509-846475353.png&sign=6a11d2d93cab09e71549bb2c79f36ae2d50154ee7eef2de9c70922e468967395#from=url&id=rsYe1&originHeight=377&originWidth=1335&originalType=binary&ratio=1.2395833730697632&rotation=0&showTitle=false&status=done&style=none&title=)
比如B读取到了A未提交的数据。
2不可重复读：一个事务先后读取同一条记录，但两次读取的数据不同，称之为不可重复读。
![](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fimg2022.cnblogs.com%2Fblog%2F2217415%2F202205%2F2217415-20220505220828152-1242800988.png&sign=7a24991335b75103c8caf5068628044924cf8f8c807bdde9b02513b2e07e6ef5#from=url&id=FVSZP&originHeight=307&originWidth=1325&originalType=binary&ratio=1.2395833730697632&rotation=0&showTitle=false&status=done&style=none&title=)
事务A两次读取同一条记录，但是读取到的数据却是不一样的。
3幻读：一个事务按照条件查询数据时，没有对应的数据行，但是在插入数据时，又发现这行数据已经存在，好像出现了 "幻影"。
![](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fimg2022.cnblogs.com%2Fblog%2F2217415%2F202205%2F2217415-20220505220901865-532256509.png&sign=7185248e6930ef1e8f4f5adaad9b58ffd220d1987da82336787ec7dd78fd804f#from=url&id=z9oQI&originHeight=344&originWidth=1273&originalType=binary&ratio=1.2395833730697632&rotation=0&showTitle=false&status=done&style=none&title=)
不可重复读更注重(修改),幻读更注重(增加和删除)

## **5 事务隔离级别**

为了解决并发事务所引发的问题，在数据库中引入了事务隔离级别。主要有以下几种：

| 隔离级别

 | 脏读

 | 不可重复读

 | 幻读

 |
| --- | --- | --- | --- |
| Read uncommitted

 | 会

 | 会

 | 会

 |
| Read committed

 | 不会

 | 会

 | 会

 |
| Repeatable Read(默认)

 | 不会

 | 不会

 | 会

 |
| Serializable

 | 不会

 | 不会

 | 不会

 |

**查看事务隔离级别**

SELECT @@TRANSACTION_ISOLATION;

**设置事务隔离级别**

SET[ SESSION | GLOBAL ] TRANSACTION ISOLATION LEVEL { READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE }
注意：事务隔离级别越高，数据越安全，但是性能越低。
